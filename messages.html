<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - MarketPace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .messages-container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(20px);
        }

        /* Header */
        .messages-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            padding: 15px 20px;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            background: none;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
        }

        .messages-title {
            color: #00ffff;
            font-size: 24px;
            font-weight: bold;
        }

        .online-count {
            color: rgba(0, 255, 255, 0.7);
            font-size: 14px;
        }

        /* Sidebar */
        .messages-sidebar {
            width: 350px;
            border-right: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            margin-top: 70px;
        }

        .search-bar {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .search-input {
            width: 100%;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
        }

        .search-input::placeholder {
            color: rgba(0, 255, 255, 0.5);
        }

        .active-members {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .active-members h3 {
            color: #00ffff;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .active-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .active-member {
            min-width: 60px;
            text-align: center;
            cursor: pointer;
        }

        .active-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            position: relative;
            margin-bottom: 5px;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #00ff00;
            border-radius: 50%;
            border: 2px solid rgba(0, 20, 40, 0.95);
        }

        .active-name {
            font-size: 12px;
            color: rgba(0, 255, 255, 0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .conversation-item:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        .conversation-item.active {
            background: rgba(0, 255, 255, 0.2);
            border-left: 3px solid #00ffff;
        }

        .conversation-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            position: relative;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            color: #00ffff;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .conversation-preview {
            color: rgba(0, 255, 255, 0.7);
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-meta {
            text-align: right;
        }

        .conversation-time {
            color: rgba(0, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 3px;
        }

        .unread-badge {
            background: #00ffff;
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-top: 70px;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .chat-info h3 {
            color: #00ffff;
            margin-bottom: 3px;
        }

        .chat-status {
            color: rgba(0, 255, 255, 0.7);
            font-size: 13px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(45deg, #00ffff, #0066ff);
            color: white;
        }

        .message.received {
            align-self: flex-start;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
        }

        .chat-input::placeholder {
            color: rgba(0, 255, 255, 0.5);
        }

        .send-btn {
            background: linear-gradient(45deg, #00ffff, #0066ff);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .empty-chat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: rgba(0, 255, 255, 0.5);
            text-align: center;
        }

        .empty-chat h3 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .messages-sidebar {
                width: 100%;
                position: absolute;
                z-index: 50;
                background: rgba(0, 20, 40, 0.98);
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .messages-sidebar.show {
                transform: translateX(0);
            }

            .chat-area {
                width: 100%;
            }
        }

        /* Notification Badge */
        .notification-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ffff;
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="messages-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">← Back</button>
            <h1 class="messages-title">Messages</h1>
            <div class="online-count" id="onlineCount">5 members online</div>
        </div>
    </div>

    <div class="messages-container">
        <!-- Sidebar -->
        <div class="messages-sidebar" id="messagesSidebar">
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search conversations..." id="searchInput">
            </div>

            <div class="active-members">
                <h3>Active Now</h3>
                <div class="active-list" id="activeList">
                    <!-- Active members will be populated here -->
                </div>
            </div>

            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be populated here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="empty-chat">
                <h3>Select a conversation</h3>
                <p>Choose from your existing conversations or start a new one</p>
            </div>
        </div>
    </div>

    <script>
        // Message system state
        let currentConversation = null;
        let conversations = new Map();
        let activeMembers = new Set();
        let unreadCounts = new Map();

        // Sample data for demo
        const sampleMembers = [
            { id: 1, name: 'Sarah Martinez', avatar: 'SM', online: true, lastSeen: 'now' },
            { id: 2, name: 'Mike Johnson', avatar: 'MJ', online: true, lastSeen: 'now' },
            { id: 3, name: 'Emily Chen', avatar: 'EC', online: false, lastSeen: '5 min ago' },
            { id: 4, name: 'David Rodriguez', avatar: 'DR', online: true, lastSeen: 'now' },
            { id: 5, name: 'Lisa Thompson', avatar: 'LT', online: false, lastSeen: '2 hours ago' },
            { id: 6, name: 'Alex Kim', avatar: 'AK', online: true, lastSeen: 'now' },
            { id: 7, name: 'Jennifer Davis', avatar: 'JD', online: false, lastSeen: '1 day ago' }
        ];

        // Initialize conversations with sample data
        conversations.set(1, {
            id: 1,
            member: sampleMembers[0],
            messages: [
                { id: 1, text: 'Hey! Are you still selling that vintage camera?', sent: false, timestamp: new Date(Date.now() - 300000) },
                { id: 2, text: 'Yes! It\'s still available. Would you like to see more photos?', sent: true, timestamp: new Date(Date.now() - 240000) },
                { id: 3, text: 'That would be great! Can we meet tomorrow?', sent: false, timestamp: new Date(Date.now() - 60000) }
            ],
            lastMessage: 'That would be great! Can we meet tomorrow?',
            lastTime: new Date(Date.now() - 60000),
            unread: 1
        });

        conversations.set(2, {
            id: 2,
            member: sampleMembers[1],
            messages: [
                { id: 1, text: 'Thanks for the handyman service recommendation!', sent: false, timestamp: new Date(Date.now() - 3600000) },
                { id: 2, text: 'You\'re welcome! How did it go?', sent: true, timestamp: new Date(Date.now() - 3000000) }
            ],
            lastMessage: 'You\'re welcome! How did it go?',
            lastTime: new Date(Date.now() - 3000000),
            unread: 0
        });

        conversations.set(4, {
            id: 4,
            member: sampleMembers[3],
            messages: [
                { id: 1, text: 'Is the guitar lesson still available this weekend?', sent: false, timestamp: new Date(Date.now() - 1800000) },
                { id: 2, text: 'Yes! Saturday at 2 PM works for me.', sent: true, timestamp: new Date(Date.now() - 1200000) },
                { id: 3, text: 'Perfect! See you then.', sent: false, timestamp: new Date(Date.now() - 900000) }
            ],
            lastMessage: 'Perfect! See you then.',
            lastTime: new Date(Date.now() - 900000),
            unread: 0
        });

        // Initialize the messaging interface
        function initializeMessaging() {
            updateActiveMembers();
            updateConversationsList();
            updateOnlineCount();
            
            // Setup search functionality
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Setup real-time updates (simulate)
            setInterval(simulateIncomingMessage, 30000); // Every 30 seconds
            setInterval(updateOnlineStatus, 60000); // Every minute
        }

        function updateActiveMembers() {
            const activeList = document.getElementById('activeList');
            const onlineMembers = sampleMembers.filter(member => member.online);
            
            activeList.innerHTML = onlineMembers.map(member => `
                <div class="active-member" onclick="startNewConversation(${member.id})">
                    <div class="active-avatar">
                        ${member.avatar}
                        <div class="online-indicator"></div>
                    </div>
                    <div class="active-name">${member.name.split(' ')[0]}</div>
                </div>
            `).join('');
        }

        function updateConversationsList() {
            const conversationsList = document.getElementById('conversationsList');
            const sortedConversations = Array.from(conversations.values())
                .sort((a, b) => b.lastTime - a.lastTime);
            
            conversationsList.innerHTML = sortedConversations.map(conv => `
                <div class="conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}" 
                     onclick="openConversation(${conv.id})">
                    <div class="conversation-avatar">
                        ${conv.member.avatar}
                        ${conv.member.online ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-name">${conv.member.name}</div>
                        <div class="conversation-preview">${conv.lastMessage}</div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${formatTime(conv.lastTime)}</div>
                        ${conv.unread > 0 ? `<div class="unread-badge">${conv.unread}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openConversation(conversationId) {
            currentConversation = conversations.get(conversationId);
            if (!currentConversation) return;
            
            // Mark as read
            currentConversation.unread = 0;
            
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">
                        ${currentConversation.member.avatar}
                    </div>
                    <div class="chat-info">
                        <h3>${currentConversation.member.name}</h3>
                        <div class="chat-status">${currentConversation.member.online ? 'Active now' : `Last seen ${currentConversation.member.lastSeen}`}</div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    ${currentConversation.messages.map(message => `
                        <div class="message ${message.sent ? 'sent' : 'received'}">
                            <div>${message.text}</div>
                            <div class="message-time">${formatTime(message.timestamp)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Type a message..." 
                           id="messageInput" onkeypress="handleEnterKey(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                        </svg>
                    </button>
                </div>
            `;
            
            // Scroll to bottom
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            updateConversationsList();
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput.value.trim();
            
            if (!messageText || !currentConversation) return;
            
            const newMessage = {
                id: Date.now(),
                text: messageText,
                sent: true,
                timestamp: new Date()
            };
            
            currentConversation.messages.push(newMessage);
            currentConversation.lastMessage = messageText;
            currentConversation.lastTime = new Date();
            
            messageInput.value = '';
            saveConversations(); // Save to localStorage
            openConversation(currentConversation.id);
            updateConversationsList();
            
            // Simulate response after 2-5 seconds
            setTimeout(simulateResponse, Math.random() * 3000 + 2000);
        }

        function simulateResponse() {
            if (!currentConversation) return;
            
            const responses = [
                "Sounds good!",
                "Let me check and get back to you.",
                "That works for me.",
                "Thanks for the message!",
                "I'll be there.",
                "Great! Looking forward to it."
            ];
            
            const response = {
                id: Date.now(),
                text: responses[Math.floor(Math.random() * responses.length)],
                sent: false,
                timestamp: new Date()
            };
            
            currentConversation.messages.push(response);
            currentConversation.lastMessage = response.text;
            currentConversation.lastTime = new Date();
            
            openConversation(currentConversation.id);
            updateConversationsList();
        }

        function startNewConversation(memberId) {
            const member = sampleMembers.find(m => m.id === memberId);
            if (!member) return;
            
            // Check if conversation already exists
            let existingConv = Array.from(conversations.values()).find(conv => conv.member.id === memberId);
            
            if (existingConv) {
                openConversation(existingConv.id);
                return;
            }
            
            // Create new conversation
            const newConversation = {
                id: Date.now(),
                member: member,
                messages: [],
                lastMessage: 'Start a conversation...',
                lastTime: new Date(),
                unread: 0
            };
            
            conversations.set(newConversation.id, newConversation);
            openConversation(newConversation.id);
            updateConversationsList();
        }

        function simulateIncomingMessage() {
            const activeConvs = Array.from(conversations.values()).filter(conv => conv.member.online);
            if (activeConvs.length === 0) return;
            
            const randomConv = activeConvs[Math.floor(Math.random() * activeConvs.length)];
            const incomingMessages = [
                "Hey, are you available?",
                "Quick question about your listing",
                "Is this still available?",
                "Thanks for your help earlier!",
                "Can we schedule a meeting?",
                "I'm interested in your service"
            ];
            
            const newMessage = {
                id: Date.now(),
                text: incomingMessages[Math.floor(Math.random() * incomingMessages.length)],
                sent: false,
                timestamp: new Date()
            };
            
            randomConv.messages.push(newMessage);
            randomConv.lastMessage = newMessage.text;
            randomConv.lastTime = new Date();
            
            if (currentConversation?.id !== randomConv.id) {
                randomConv.unread = (randomConv.unread || 0) + 1;
                showNotification(`New message from ${randomConv.member.name}`, newMessage.text);
            }
            
            if (currentConversation?.id === randomConv.id) {
                openConversation(randomConv.id);
            }
            
            updateConversationsList();
        }

        function showNotification(title, message) {
            // Show browser notification if permission granted
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico'
                });
            }
            
            // Show in-app notification
            const notification = document.createElement('div');
            notification.className = 'notification-badge';
            notification.textContent = `${title}: ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const conversationItems = document.querySelectorAll('.conversation-item');
            
            conversationItems.forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateOnlineStatus() {
            // Randomly update online status for demo
            sampleMembers.forEach(member => {
                if (Math.random() < 0.1) { // 10% chance to change status
                    member.online = !member.online;
                    member.lastSeen = member.online ? 'now' : 'just now';
                }
            });
            
            updateActiveMembers();
            updateConversationsList();
            updateOnlineCount();
        }

        function updateOnlineCount() {
            const onlineCount = sampleMembers.filter(member => member.online).length;
            document.getElementById('onlineCount').textContent = `${onlineCount} members online`;
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            
            return date.toLocaleDateString();
        }

        function goBack() {
            window.history.back();
        }

        // Load conversations from localStorage (compatible with demo format)
        function loadStoredConversations() {
            const stored = localStorage.getItem('marketpace_conversations');
            if (stored) {
                try {
                    const storedConversations = JSON.parse(stored);
                    conversations.clear();
                    
                    // Convert from demo format to messages format
                    storedConversations.forEach((demoConv, index) => {
                        const member = {
                            id: index + 100,
                            name: demoConv.participants.find(p => p !== 'You') || 'Unknown',
                            avatar: (demoConv.participants.find(p => p !== 'You') || 'U').charAt(0),
                            online: Math.random() > 0.5,
                            lastSeen: 'recently'
                        };
                        
                        const conversation = {
                            id: Date.now() + index,
                            member: member,
                            messages: demoConv.messages ? demoConv.messages.map(msg => ({
                                id: Date.now() + Math.random(),
                                text: msg.message,
                                sent: msg.sender === 'You',
                                timestamp: new Date(msg.timestamp)
                            })) : [],
                            lastMessage: demoConv.lastMessage || 'No messages yet',
                            lastTime: new Date(demoConv.timestamp),
                            unread: 0
                        };
                        
                        conversations.set(conversation.id, conversation);
                    });
                    
                    console.log(`Loaded ${conversations.size} conversations from storage`);
                } catch (e) {
                    console.log('Error loading stored conversations:', e);
                }
            }
        }

        // Save conversations to localStorage (compatible with demo format)
        function saveConversations() {
            try {
                const demoFormat = Array.from(conversations.values()).map(conv => ({
                    id: 'conv_' + conv.id,
                    participants: ['You', conv.member.name],
                    lastMessage: conv.lastMessage,
                    timestamp: conv.lastTime.toISOString(),
                    itemContext: {
                        name: 'Item',
                        seller: conv.member.name
                    },
                    messages: conv.messages.map(msg => ({
                        sender: msg.sent ? 'You' : conv.member.name,
                        message: msg.text,
                        timestamp: msg.timestamp.toISOString()
                    }))
                }));
                
                localStorage.setItem('marketpace_conversations', JSON.stringify(demoFormat));
            } catch (e) {
                console.log('Error saving conversations:', e);
            }
        }

        // Enhanced initialize function
        function initializeMessaging() {
            console.log('Messages page loaded');
            loadStoredConversations();
            updateActiveMembers();
            updateConversationsList();
            updateOnlineCount();
            
            // Auto-create some conversations for demo if none exist
            if (conversations.size === 0) {
                setTimeout(() => {
                    startNewConversation(1); // Sarah's Boutique
                    startNewConversation(3); // DJ Mike
                }, 500);
            }
            
            // Simulate incoming messages periodically
            setInterval(simulateIncomingMessage, 30000);
            setInterval(updateOnlineStatus, 10000);
            
            // Setup search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeMessaging);
    </script>
</body>
</html>