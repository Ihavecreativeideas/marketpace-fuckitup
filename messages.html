<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - MarketPace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .messages-container {
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(20px);
        }

        /* Header */
        .messages-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 20, 40, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            padding: 15px 20px;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            background: none;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
        }

        .messages-title {
            color: #00ffff;
            font-size: 24px;
            font-weight: bold;
        }

        .online-count {
            color: rgba(0, 255, 255, 0.7);
            font-size: 14px;
        }

        /* Sidebar */
        .messages-sidebar {
            width: 350px;
            border-right: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            margin-top: 70px;
        }

        .search-bar {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
        }

        .search-input {
            width: 100%;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
        }

        .search-input::placeholder {
            color: rgba(0, 255, 255, 0.5);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
            align-items: center;
        }

        .conversation-item:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        .conversation-item.active {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff, #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: bold;
            color: #00ffff;
            margin-bottom: 5px;
        }

        .conversation-preview {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-meta {
            text-align: right;
        }

        .conversation-time {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .unread-badge {
            background: #00ffff;
            color: #000;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        .unread-badge.show {
            display: inline-block;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-top: 70px;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            align-items: center;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ffff, #0066ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .chat-info h3 {
            color: #00ffff;
            margin-bottom: 5px;
        }

        .chat-status {
            color: rgba(0, 255, 255, 0.7);
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #00ffff, #0066ff);
            color: #000;
        }

        .message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
        }

        .chat-input::placeholder {
            color: rgba(0, 255, 255, 0.5);
        }

        .send-btn {
            background: linear-gradient(135deg, #00ffff, #0066ff);
            border: none;
            color: #000;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .messages-container {
                flex-direction: column;
            }
            
            .messages-sidebar {
                width: 100%;
                max-height: 300px;
            }
            
            .chat-area {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="messages-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">← Back</button>
            <h1 class="messages-title">Messages</h1>
            <div class="online-count" id="onlineCount">0 members online</div>
        </div>
    </div>

    <div class="messages-container">
        <div class="messages-sidebar">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="Search conversations...">
            </div>
            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be populated here -->
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="2" y="6" width="20" height="12" rx="3"/>
                    <path d="m2 7 8.97 5.7a1.94 1.94 0 0 0 2.06 0L22 7"/>
                </svg>
                <h3>Select a conversation</h3>
                <p>Choose a conversation from the sidebar to start messaging</p>
            </div>
        </div>
    </div>

    <script>
        let conversations = new Map();
        let currentConversation = null;

        // Sample data for demo
        const sampleMembers = [
            { id: 1, name: "Sarah's Boutique", avatar: "S", online: true, lastSeen: "now" },
            { id: 2, name: "Mike's Handyman", avatar: "M", online: false, lastSeen: "5m ago" },
            { id: 3, name: "DJ Sunset Vibes", avatar: "D", online: true, lastSeen: "now" },
            { id: 4, name: "Tom's Tool Rentals", avatar: "T", online: false, lastSeen: "1h ago" }
        ];

        function initializeMessaging() {
            console.log('Messages page loaded');
            
            // Check for URL parameters to create new conversation
            const urlParams = new URLSearchParams(window.location.search);
            const seller = urlParams.get('seller');
            const item = urlParams.get('item');
            const itemId = urlParams.get('id');
            
            // Load existing conversations
            loadStoredConversations();
            
            // Handle URL parameters for new conversation
            if (seller && item) {
                console.log(`Creating new conversation with ${seller} about ${item}`);
                createNewConversationFromPost(seller, item, itemId);
                
                // Clear URL parameters
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, '', newUrl);
            }
            
            // Update UI
            updateConversationsList();
            updateOnlineCount();
            
            // Setup search
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // Setup chat input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        }

        function createNewConversationFromPost(sellerName, itemName, itemId) {
            // Check if conversation with this seller already exists
            const existingConv = Array.from(conversations.values()).find(conv => 
                conv.member.name === sellerName
            );
            
            if (existingConv) {
                // Open existing conversation
                openConversation(existingConv.id);
                return;
            }
            
            const conversationId = Date.now();
            const initialMessage = `Hi! I'm interested in ${itemName}`;
            
            const member = {
                id: conversationId,
                name: sellerName,
                avatar: sellerName.charAt(0).toUpperCase(),
                online: Math.random() > 0.5,
                lastSeen: 'recently'
            };
            
            const conversation = {
                id: conversationId,
                member: member,
                messages: [{
                    id: Date.now(),
                    text: initialMessage,
                    sent: true,
                    timestamp: new Date()
                }],
                lastMessage: initialMessage,
                lastTime: new Date(),
                unread: 0,
                itemContext: {
                    name: itemName,
                    id: itemId,
                    seller: sellerName
                }
            };
            
            conversations.set(conversationId, conversation);
            saveConversations();
            
            // Open the new conversation
            openConversation(conversationId);
            updateConversationsList();
            
            // Simulate seller response after 3 seconds
            setTimeout(() => {
                const responses = [
                    `Hi! Yes, ${itemName} is available. What would you like to know?`,
                    `Hello! I can help you with ${itemName}. When do you need it?`,
                    `Thanks for your interest in ${itemName}! I'd be happy to discuss details.`,
                    `Hi there! ${itemName} is ready. Let me know your schedule!`
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                addMessageToConversation(conversationId, response, false);
            }, 3000);
        }

        function loadStoredConversations() {
            const stored = localStorage.getItem('marketpace_conversations');
            if (stored) {
                try {
                    const storedConversations = JSON.parse(stored);
                    conversations.clear();
                    
                    // Convert from stored format
                    storedConversations.forEach((demoConv, index) => {
                        const otherParticipant = demoConv.participants ? 
                            demoConv.participants.find(p => p !== 'You') : 'Unknown';
                        
                        const member = {
                            id: index + 100,
                            name: otherParticipant || 'Unknown',
                            avatar: (otherParticipant || 'U').charAt(0).toUpperCase(),
                            online: Math.random() > 0.5,
                            lastSeen: 'recently'
                        };
                        
                        const conversation = {
                            id: parseInt(demoConv.id.replace('conv_', '')) || (Date.now() + index),
                            member: member,
                            messages: demoConv.messages ? demoConv.messages.map((msg, msgIndex) => ({
                                id: Date.now() + msgIndex,
                                text: msg.message || msg.text || 'No message',
                                sent: msg.sender === 'You',
                                timestamp: new Date(msg.timestamp)
                            })) : [],
                            lastMessage: demoConv.lastMessage || 'No messages yet',
                            lastTime: new Date(demoConv.timestamp),
                            unread: 0
                        };
                        
                        conversations.set(conversation.id, conversation);
                    });
                    
                    console.log(`Loaded ${conversations.size} conversations from storage`);
                } catch (e) {
                    console.log('Error loading stored conversations:', e);
                }
            }
        }

        function saveConversations() {
            try {
                const demoFormat = Array.from(conversations.values()).map(conv => ({
                    id: 'conv_' + conv.id,
                    participants: ['You', conv.member.name],
                    lastMessage: conv.lastMessage,
                    timestamp: conv.lastTime.toISOString(),
                    itemContext: conv.itemContext || {
                        name: 'Item',
                        seller: conv.member.name
                    },
                    messages: conv.messages.map(msg => ({
                        sender: msg.sent ? 'You' : conv.member.name,
                        message: msg.text,
                        timestamp: msg.timestamp.toISOString()
                    }))
                }));
                
                localStorage.setItem('marketpace_conversations', JSON.stringify(demoFormat));
            } catch (e) {
                console.log('Error saving conversations:', e);
            }
        }

        function updateConversationsList() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = '';
            
            const sortedConversations = Array.from(conversations.values())
                .sort((a, b) => new Date(b.lastTime) - new Date(a.lastTime));
            
            sortedConversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = `conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}`;
                item.onclick = () => openConversation(conv.id);
                
                item.innerHTML = `
                    <div class="conversation-avatar">${conv.member.avatar}</div>
                    <div class="conversation-info">
                        <div class="conversation-name">${conv.member.name}</div>
                        <div class="conversation-preview">${conv.lastMessage}</div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${formatTime(conv.lastTime)}</div>
                        <div class="unread-badge ${conv.unread > 0 ? 'show' : ''}">${conv.unread}</div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function openConversation(conversationId) {
            const conversation = conversations.get(conversationId);
            if (!conversation) return;
            
            currentConversation = conversation;
            conversation.unread = 0;
            
            // Update chat area
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">${conversation.member.avatar}</div>
                    <div class="chat-info">
                        <h3>${conversation.member.name}</h3>
                        <div class="chat-status">${conversation.member.online ? 'Online' : `Last seen ${conversation.member.lastSeen}`}</div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    ${conversation.messages.map(msg => `
                        <div class="message ${msg.sent ? 'sent' : 'received'}">
                            <div>${msg.text}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message...">
                    <button class="send-btn" onclick="sendMessage()">→</button>
                </div>
            `;
            
            // Setup enter key handler for new input
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Scroll to bottom
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            updateConversationsList();
            saveConversations();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (!input || !currentConversation) return;
            
            const messageText = input.value.trim();
            if (!messageText) return;
            
            // Add message to conversation
            const message = {
                id: Date.now(),
                text: messageText,
                sent: true,
                timestamp: new Date()
            };
            
            currentConversation.messages.push(message);
            currentConversation.lastMessage = messageText;
            currentConversation.lastTime = new Date();
            
            // Clear input
            input.value = '';
            
            // Update chat display
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message sent';
            messageElement.innerHTML = `
                <div>${messageText}</div>
                <div class="message-time">${formatTime(new Date())}</div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update conversations list
            updateConversationsList();
            saveConversations();
            
            // Simulate response after 2-4 seconds
            setTimeout(() => {
                simulateResponse();
            }, Math.random() * 2000 + 2000);
        }

        function addMessageToConversation(conversationId, messageText, sent) {
            const conversation = conversations.get(conversationId);
            if (!conversation) return;
            
            const message = {
                id: Date.now(),
                text: messageText,
                sent: sent,
                timestamp: new Date()
            };
            
            conversation.messages.push(message);
            conversation.lastMessage = messageText;
            conversation.lastTime = new Date();
            
            if (!sent) {
                conversation.unread++;
            }
            
            // Update display if this conversation is currently open
            if (currentConversation && currentConversation.id === conversationId) {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${sent ? 'sent' : 'received'}`;
                    messageElement.innerHTML = `
                        <div>${messageText}</div>
                        <div class="message-time">${formatTime(new Date())}</div>
                    `;
                    messagesContainer.appendChild(messageElement);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
                conversation.unread = 0;
            }
            
            updateConversationsList();
            saveConversations();
        }

        function simulateResponse() {
            if (!currentConversation) return;
            
            const responses = [
                "That sounds great!",
                "I can help you with that.",
                "When would you like to schedule this?",
                "Let me check my availability.",
                "What's your budget for this?",
                "I'll send you more details.",
                "Thanks for reaching out!"
            ];
            
            const response = responses[Math.floor(Math.random() * responses.length)];
            addMessageToConversation(currentConversation.id, response, false);
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.conversation-item');
            
            items.forEach(item => {
                const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                const preview = item.querySelector('.conversation-preview').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateOnlineCount() {
            const onlineCount = Math.floor(Math.random() * 10) + 5;
            document.getElementById('onlineCount').textContent = `${onlineCount} members online`;
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - new Date(date);
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            
            return new Date(date).toLocaleDateString();
        }

        function goBack() {
            window.history.back();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeMessaging);
    </script>
</body>
</html>