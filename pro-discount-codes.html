<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pro Discount Codes - MarketPace</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
    }

    .back-button {
      background: none;
      border: none;
      color: #00ffff;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: rgba(0, 255, 255, 0.1);
      transform: translateX(-5px);
    }

    .marketpace-text {
      color: #2a0845;
      font-weight: 700;
      font-size: 32px;
      text-shadow: 0 1px 3px rgba(42, 8, 69, 0.5);
    }

    .pro-badge {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #000;
      padding: 8px 16px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 14px;
      text-shadow: none;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .create-code-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      color: #00ffff;
      margin-bottom: 8px;
      font-weight: bold;
    }

    input, select, textarea {
      padding: 12px;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 14px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    .btn-generate {
      background: linear-gradient(135deg, #00ffff, #0066ff);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
    }

    .btn-create {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #000;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-top: 20px;
      transition: all 0.3s ease;
      width: 200px;
    }

    .btn-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
    }

    .codes-list {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      overflow: hidden;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .codes-header {
      background: rgba(0, 255, 255, 0.1);
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .code-item {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .code-info h3 {
      color: #00ffff;
      margin-bottom: 5px;
    }

    .code-details {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    .code-actions {
      display: flex;
      gap: 10px;
    }

    .btn-edit, .btn-delete, .btn-stats {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-edit {
      background: #4CAF50;
      color: white;
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-stats {
      background: #2196F3;
      color: white;
    }

    .btn-edit:hover, .btn-delete:hover, .btn-stats:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .stats-badge {
      background: rgba(0, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }

    .expired {
      opacity: 0.5;
    }

    .inactive {
      opacity: 0.6;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #000428 0%, #004e92 100%);
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }

    .no-codes {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.7);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #00ffff;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .code-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .code-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-button" onclick="goBack()">← Back</button>
      <h1 class="marketpace-text">MARKETPACE</h1>
      <span class="pro-badge">PRO DISCOUNT CODES</span>
    </div>

    <div class="create-code-section">
      <h2 style="color: #00ffff; margin-bottom: 20px;">Create New Discount Code</h2>
      <form id="createCodeForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="codeName">Code Name *</label>
            <input type="text" id="codeName" name="name" required placeholder="e.g., Summer Sale 2025">
          </div>
          <div class="form-group">
            <label for="codeString">Discount Code *</label>
            <div style="display: flex; align-items: center;">
              <input type="text" id="codeString" name="code" required placeholder="e.g., SUMMER25" maxlength="20">
              <button type="button" class="btn-generate" onclick="generateCode()">Generate</button>
            </div>
          </div>
          <div class="form-group">
            <label for="discountType">Discount Type *</label>
            <select id="discountType" name="type" required onchange="updateDiscountFields()">
              <option value="percentage">Percentage Off</option>
              <option value="fixed_amount">Fixed Amount Off</option>
              <option value="free_shipping">Free Shipping</option>
            </select>
          </div>
          <div class="form-group" id="valueGroup">
            <label for="discountValue">Discount Value *</label>
            <input type="number" id="discountValue" name="value" required min="1" max="100" placeholder="25">
          </div>
          <div class="form-group">
            <label for="minPurchase">Minimum Purchase ($)</label>
            <input type="number" id="minPurchase" name="minimumPurchase" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group" id="maxDiscountGroup">
            <label for="maxDiscount">Maximum Discount ($)</label>
            <input type="number" id="maxDiscount" name="maximumDiscount" min="0" step="0.01" placeholder="Optional">
          </div>
          <div class="form-group">
            <label for="usageLimit">Usage Limit</label>
            <input type="number" id="usageLimit" name="usageLimit" min="1" placeholder="Leave blank for unlimited">
          </div>
          <div class="form-group">
            <label for="validUntil">Expiration Date</label>
            <input type="datetime-local" id="validUntil" name="validUntil">
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="3" placeholder="Brief description of this discount code..."></textarea>
        </div>
        <button type="submit" class="btn-create">Create Discount Code</button>
      </form>
    </div>

    <div class="codes-list">
      <div class="codes-header">
        <h2 style="color: #00ffff;">Your Discount Codes</h2>
      </div>
      <div id="codesList" class="loading">
        Loading discount codes...
      </div>
    </div>
  </div>

  <!-- Edit Code Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #00ffff;">Edit Discount Code</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editCodeForm">
        <div class="form-group">
          <label for="editCodeName">Code Name</label>
          <input type="text" id="editCodeName" name="name" required>
        </div>
        <div class="form-group">
          <label for="editDescription">Description</label>
          <textarea id="editDescription" name="description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="editUsageLimit">Usage Limit</label>
          <input type="number" id="editUsageLimit" name="usageLimit" min="1">
        </div>
        <div class="form-group">
          <label for="editValidUntil">Expiration Date</label>
          <input type="datetime-local" id="editValidUntil" name="validUntil">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="editIsActive" name="isActive">
            Code is Active
          </label>
        </div>
        <button type="submit" class="btn-create">Update Code</button>
      </form>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #00ffff;">Code Statistics</h2>
        <button class="close-btn" onclick="closeStatsModal()">&times;</button>
      </div>
      <div id="statsContent">
        Loading statistics...
      </div>
    </div>
  </div>

  <script>
    let currentBusinessId = null;
    let editingCodeId = null;
    let discountCodes = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Get business ID from localStorage or URL params
      currentBusinessId = localStorage.getItem('currentBusinessId') || getUrlParameter('businessId');
      if (!currentBusinessId) {
        alert('Business ID required');
        goBack();
        return;
      }
      
      loadDiscountCodes();
      setMinDateTime();
    });

    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function setMinDateTime() {
      const now = new Date();
      const minDateTime = now.toISOString().slice(0, 16);
      document.getElementById('validUntil').min = minDateTime;
      document.getElementById('editValidUntil').min = minDateTime;
    }

    function goBack() {
      window.history.back();
    }

    function updateDiscountFields() {
      const type = document.getElementById('discountType').value;
      const valueGroup = document.getElementById('valueGroup');
      const maxDiscountGroup = document.getElementById('maxDiscountGroup');
      const valueInput = document.getElementById('discountValue');
      const valueLabel = valueGroup.querySelector('label');
      
      if (type === 'percentage') {
        valueLabel.textContent = 'Percentage Off (%) *';
        valueInput.max = '100';
        valueInput.placeholder = '25';
        maxDiscountGroup.style.display = 'block';
      } else if (type === 'fixed_amount') {
        valueLabel.textContent = 'Amount Off ($) *';
        valueInput.max = '10000';
        valueInput.placeholder = '10.00';
        maxDiscountGroup.style.display = 'none';
      } else {
        valueGroup.style.display = 'none';
        maxDiscountGroup.style.display = 'none';
      }
    }

    async function generateCode() {
      try {
        const response = await fetch('/api/business/discount-codes/generate-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ length: 8 })
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('codeString').value = data.code;
        } else {
          console.error('Failed to generate code');
        }
      } catch (error) {
        console.error('Error generating code:', error);
      }
    }

    async function loadDiscountCodes() {
      try {
        const response = await fetch(`/api/business/${currentBusinessId}/discount-codes`);
        
        if (response.ok) {
          discountCodes = await response.json();
          displayDiscountCodes();
        } else {
          throw new Error('Failed to load discount codes');
        }
      } catch (error) {
        console.error('Error loading discount codes:', error);
        document.getElementById('codesList').innerHTML = '<div class="no-codes">Error loading discount codes</div>';
      }
    }

    function displayDiscountCodes() {
      const container = document.getElementById('codesList');
      
      if (discountCodes.length === 0) {
        container.innerHTML = '<div class="no-codes">No discount codes created yet. Create your first one above!</div>';
        return;
      }

      const html = discountCodes.map(code => {
        const isExpired = code.validUntil && new Date(code.validUntil) < new Date();
        const isInactive = !code.isActive;
        const statusClass = isExpired ? 'expired' : (isInactive ? 'inactive' : '');
        
        return `
          <div class="code-item ${statusClass}">
            <div class="code-info">
              <h3>${code.name} - ${code.code}</h3>
              <div class="code-details">
                ${getDiscountDisplay(code)} • 
                Used: ${code.usedCount || 0}${code.usageLimit ? `/${code.usageLimit}` : ''} • 
                ${code.validUntil ? `Expires: ${new Date(code.validUntil).toLocaleDateString()}` : 'Never expires'}
                ${isExpired ? '<span class="stats-badge" style="background: rgba(244, 67, 54, 0.2);">EXPIRED</span>' : ''}
                ${isInactive ? '<span class="stats-badge" style="background: rgba(158, 158, 158, 0.2);">INACTIVE</span>' : ''}
              </div>
            </div>
            <div class="code-actions">
              <button class="btn-stats" onclick="showStats('${code.id}')">Stats</button>
              <button class="btn-edit" onclick="editCode('${code.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteCode('${code.id}', '${code.name}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function getDiscountDisplay(code) {
      if (code.type === 'percentage') {
        return `${code.value}% off`;
      } else if (code.type === 'fixed_amount') {
        return `$${(code.value / 100).toFixed(2)} off`;
      } else {
        return 'Free shipping';
      }
    }

    // Form submission
    document.getElementById('createCodeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Convert values to appropriate types
      data.businessId = currentBusinessId;
      data.value = data.type === 'fixed_amount' ? Math.round(parseFloat(data.value) * 100) : parseInt(data.value);
      if (data.minimumPurchase) data.minimumPurchase = Math.round(parseFloat(data.minimumPurchase) * 100);
      if (data.maximumDiscount) data.maximumDiscount = Math.round(parseFloat(data.maximumDiscount) * 100);
      if (data.usageLimit) data.usageLimit = parseInt(data.usageLimit);
      
      try {
        const response = await fetch('/api/business/discount-codes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Discount code created successfully!');
          e.target.reset();
          loadDiscountCodes();
        } else {
          const error = await response.json();
          alert(error.message || 'Failed to create discount code');
        }
      } catch (error) {
        console.error('Error creating discount code:', error);
        alert('Error creating discount code');
      }
    });

    function editCode(codeId) {
      const code = discountCodes.find(c => c.id === codeId);
      if (!code) return;

      editingCodeId = codeId;
      document.getElementById('editCodeName').value = code.name || '';
      document.getElementById('editDescription').value = code.description || '';
      document.getElementById('editUsageLimit').value = code.usageLimit || '';
      document.getElementById('editValidUntil').value = code.validUntil ? new Date(code.validUntil).toISOString().slice(0, 16) : '';
      document.getElementById('editIsActive').checked = code.isActive;
      
      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      editingCodeId = null;
    }

    document.getElementById('editCodeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!editingCodeId) return;
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Convert checkbox
      data.isActive = document.getElementById('editIsActive').checked;
      if (data.usageLimit) data.usageLimit = parseInt(data.usageLimit);
      
      try {
        const response = await fetch(`/api/business/discount-codes/${editingCodeId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('Discount code updated successfully!');
          closeEditModal();
          loadDiscountCodes();
        } else {
          const error = await response.json();
          alert(error.message || 'Failed to update discount code');
        }
      } catch (error) {
        console.error('Error updating discount code:', error);
        alert('Error updating discount code');
      }
    });

    async function deleteCode(codeId, codeName) {
      if (!confirm(`Are you sure you want to delete the discount code "${codeName}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/business/discount-codes/${codeId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('Discount code deleted successfully!');
          loadDiscountCodes();
        } else {
          const error = await response.json();
          alert(error.message || 'Failed to delete discount code');
        }
      } catch (error) {
        console.error('Error deleting discount code:', error);
        alert('Error deleting discount code');
      }
    }

    async function showStats(codeId) {
      document.getElementById('statsContent').innerHTML = 'Loading statistics...';
      document.getElementById('statsModal').style.display = 'block';

      try {
        const response = await fetch(`/api/business/discount-codes/${codeId}/stats`);
        
        if (response.ok) {
          const stats = await response.json();
          displayStats(stats);
        } else {
          throw new Error('Failed to load stats');
        }
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('statsContent').innerHTML = 'Error loading statistics';
      }
    }

    function displayStats(stats) {
      const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div style="text-align: center; padding: 20px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
            <h3 style="color: #00ffff; margin-bottom: 10px;">Total Uses</h3>
            <div style="font-size: 24px; font-weight: bold;">${stats.totalUses || 0}</div>
          </div>
          <div style="text-align: center; padding: 20px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
            <h3 style="color: #00ffff; margin-bottom: 10px;">Total Savings</h3>
            <div style="font-size: 24px; font-weight: bold;">$${((stats.totalDiscountAmount || 0) / 100).toFixed(2)}</div>
          </div>
          <div style="text-align: center; padding: 20px; background: rgba(0, 255, 255, 0.1); border-radius: 10px;">
            <h3 style="color: #00ffff; margin-bottom: 10px;">Revenue Generated</h3>
            <div style="font-size: 24px; font-weight: bold;">$${((stats.totalRevenue || 0) / 100).toFixed(2)}</div>
          </div>
        </div>
        ${stats.recentUsage && stats.recentUsage.length > 0 ? `
          <div style="margin-top: 30px;">
            <h3 style="color: #00ffff; margin-bottom: 15px;">Recent Usage</h3>
            <div style="max-height: 200px; overflow-y: auto;">
              ${stats.recentUsage.map(usage => `
                <div style="padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                  <div>Discount: $${(usage.discountAmount / 100).toFixed(2)} on $${(usage.originalAmount / 100).toFixed(2)} order</div>
                  <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">${new Date(usage.usedAt).toLocaleString()}</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
      
      document.getElementById('statsContent').innerHTML = html;
    }

    function closeStatsModal() {
      document.getElementById('statsModal').style.display = 'none';
    }

    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // Initialize discount type fields
    updateDiscountFields();
  </script>
</body>
</html>