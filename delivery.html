<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Deliveries - MarketPace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                radial-gradient(circle at 20% 30%, rgba(29, 11, 61, 0.9) 0%, transparent 60%),
                radial-gradient(circle at 80% 70%, rgba(20, 184, 166, 0.4) 0%, transparent 50%),
                linear-gradient(135deg, #1a0b3d 0%, #1e1b4b 25%, #1e3a8a 50%, #0f172a 75%, #134e4a 100%);
            color: #ffffff;
            padding-bottom: 80px;
            font-weight: 400;
            letter-spacing: 0.01em;
            position: relative;
            overflow-x: hidden;
        }

        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* Moving Sonar Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            transform: translate(-50%, -50%);
            background: 
                radial-gradient(circle at center, 
                    transparent 30%, 
                    rgba(20, 184, 166, 0.15) 31%, 
                    rgba(20, 184, 166, 0.15) 32%, 
                    transparent 33%,
                    transparent 50%,
                    rgba(14, 165, 233, 0.1) 51%,
                    rgba(14, 165, 233, 0.1) 52%,
                    transparent 53%,
                    transparent 70%,
                    rgba(59, 130, 246, 0.08) 71%,
                    rgba(59, 130, 246, 0.08) 72%,
                    transparent 73%
                );
            animation: sonarPulse 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
            opacity: 0.9;
        }
        
        @keyframes sonarPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0.7;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.8) 0%, rgba(59, 130, 246, 0.2) 70%, transparent 100%);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 191, 255, 0.2);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .logo-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
        }

        .logo-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.5);
        }

        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .profile-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: white;
            font-size: 14px;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
            overflow: hidden;
        }

        .profile-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.5);
        }

        .profile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .map-btn {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 191, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.3);
        }

        .map-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 191, 255, 0.5);
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
        }

        /* Main Content */
        .main-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 16px;
            position: relative;
            z-index: 10;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 24px 0;
            color: #ffffff;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin: 20px 0;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            font-weight: 600;
            margin-bottom: 20px;
        }

        .delivery-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .delivery-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: bold;
        }

        .delivery-type.purchase {
            background: rgba(0, 100, 255, 0.3);
            color: #64b5f6;
            border: 1px solid rgba(0, 100, 255, 0.5);
        }

        .delivery-type.sale {
            background: rgba(255, 50, 50, 0.3);
            color: #ff8a80;
            border: 1px solid rgba(255, 50, 50, 0.5);
        }

        .delivery-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: bold;
        }

        .delivery-status.picked-up {
            background: rgba(255, 217, 61, 0.3);
            color: #ffd93d;
        }

        .delivery-status.in-transit {
            text-shadow: 0 0 8px rgba(147, 197, 253, 0.6);
        }

        .delivery-status.delivered {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .delivery-status.returned {
            background: rgba(255, 87, 34, 0.3);
            color: #ff5722;
        }

        .item-info {
            margin: 12px 0;
        }

        .item-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .item-details {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .driver-info {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #ffffff;
            margin-right: 12px;
        }

        .driver-details .rating {
            font-size: 12px;
            color: #ffd93d;
        }

        .route-progress {
            margin: 12px 0;
        }

        .route-info {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 8px;
        }

        .progress-fill {
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .stops-list {
            font-size: 11px;
            opacity: 0.7;
        }

        .delivery-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 191, 255, 0.2);
            color: #ffffff;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            display: inline-block;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px 6px;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 0 20px rgba(0, 191, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: rgba(0, 191, 255, 0.4);
            transform: translateY(-1px);
            box-shadow: 
                0 0 30px rgba(0, 191, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .action-btn:hover::before {
            left: 100%;
        }

        
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            z-index: -1;
        }

        
        
        .action-btn:active {
            transform: translateY(0);
            box-shadow: 
                0 1px 4px rgba(0, 168, 204, 0.3),
                inset 0 1px 0 rgba(0, 0, 0, 0.3),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1);
        }

        .action-btn.primary {
            border-color: #00d4ff;
            color: #00d4ff;
            text-shadow: 0 0 6px rgba(0, 212, 255, 0.8);
        }
        
        .action-btn.primary:hover {
            border-color: #00ffaa;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 1);
        }

        .action-btn.danger {
            font-weight: 600;
        }

        .cost-breakdown {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .notification-banner {
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-weight: bold;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 26, 51, 0.9);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(0, 204, 255, 0.5);
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            background: none;
            border: none;
            color: rgba(0, 204, 255, 0.8);
            padding: 10px 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: 500;
        }

        .nav-item.active {
            color: #00ccff;
            transform: translateY(-2px);
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 10px;
        }

        /* Honor System Features */
        .delivery-size-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 12px;
        }

        .size-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
        }

        .size-small { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .size-medium { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .size-large { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .size-bulk { background: rgba(138, 43, 226, 0.2); color: #8a2be2; }

        .honor-system-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 12px;
            text-align: center;
        }

        .delivery-fee-breakdown {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 12px;
        }

        .fee-line {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .fee-line.total {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
            font-weight: bold;
            color: #00d4ff;
        }

        .honesty-rating {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 12px;
        }

        .rating-stars {
            margin-left: 8px;
        }

        .star {
            color: #ffd93d;
            margin-right: 2px;
        }

        /* Rating Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            color: #00d4ff;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .star {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.active {
            color: #ffd93d;
        }

        .tip-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 16px 0;
        }

        .tip-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tip-btn.selected {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 10px;
            color: white;
            font-size: 14px;
            margin: 8px 0;
        }

        .form-textarea {
            height: 80px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            margin-top: 12px;
            letter-spacing: 0.01em;
        let selectedTip = 0;
        let currentDriverId = '';
        let currentOrderId = '';

        // Initialize floating particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                
                // Space traveler particle colors
                const colors = [
                    'radial-gradient(circle, #64c8ff 0%, #4fb3ff 50%, transparent 100%)',
                    'radial-gradient(circle, #85d4ff 0%, #64c8ff 50%, transparent 100%)',
                    'radial-gradient(circle, #a3e0ff 0%, #85d4ff 50%, transparent 100%)'
                ];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.boxShadow = '0 0 ' + (Math.random() * 8 + 4) + 'px rgba(100, 200, 255, 0.6)';
                
                container.appendChild(particle);
            }
        }

        // Tab switching
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide content
            document.getElementById('current').style.display = tab === 'current' ? 'block' : 'none';
            document.getElementById('past').style.display = tab === 'past' ? 'block' : 'none';
        }

        // Navigation functions
        function goToPage(page) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Navigate to different pages
            switch(page) {
                case 'home':
                    window.location.href = '/community';
                    break;
                case 'shop':
                    window.location.href = '/shops';
                    break;
                case 'services':
                    // Filter community for services
                    window.location.href = '/community?filter=services';
                    break;
                case 'hub':
                    window.location.href = '/the-hub';
                    break;
                case 'delivery':
                    // Already on delivery page
                    break;
                case 'menu':
                    window.location.href = '/menu';
                    break;
            }
        }

        // Delivery action functions
        function trackLive(orderId) {
            alert(`Opening live tracking for order ${orderId}...\n\nYou can see real-time driver location and estimated arrival time.`);
        }

        function contactDriver(driverId) {
            alert(`Opening message thread with ${driverId.replace('-', ' ')}...\n\nYou can send messages about delivery instructions or ask for updates.`);
        }

        function declineDelivery(orderId) {
            if (confirm('Are you sure you want to decline this delivery?\n\nNote: The item will be returned to the seller, and return fees may apply ($2 + $0.50/mile).')) {
                alert(`Delivery ${orderId} declined. The driver has been notified and will return the item to the seller.\n\nReturn routing has been optimized and may affect other delivery times.`);
                // In real app: update delivery status and re-route
            }
        }

        function rateDriver(driverId, orderId) {
            currentDriverId = driverId;
            currentOrderId = orderId;
            document.getElementById('driverName').textContent = driverId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('ratingModal').style.display = 'block';
        }

        function closeRatingModal() {
            document.getElementById('ratingModal').style.display = 'none';
            currentRating = 0;
            selectedTip = 0;
            // Reset UI
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.querySelectorAll('.tip-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('reviewText').value = '';
            document.getElementById('customTip').value = '';
        }

        function setRating(rating) {
            currentRating = rating;
            document.querySelectorAll('.star').forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }

        function selectTip(amount) {
            selectedTip = amount;
            document.querySelectorAll('.tip-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('customTip').value = '';
        }

        function submitRating() {
            const customTip = parseFloat(document.getElementById('customTip').value) || 0;
            const finalTip = customTip > 0 ? customTip : selectedTip;
            const review = document.getElementById('reviewText').value;

            if (currentRating === 0) {
                alert('Please select a rating before submitting.');
                return;
            }

            alert(`Rating submitted!\n\n‚≠ê Rating: ${currentRating} stars\nüí∞ Tip: $${finalTip.toFixed(2)}\nüìù Review: ${review || 'No review provided'}\n\nThank you for your feedback! The driver has been notified.`);
            
            closeRatingModal();
        }

        function tipDriver(driverId) {
            const tip = prompt('Enter tip amount (100% goes to driver):', '3.00');
            if (tip && !isNaN(tip) && parseFloat(tip) > 0) {
                alert(`$${parseFloat(tip).toFixed(2)} tip sent to ${driverId.replace('-', ' ')}!\n\nThank you for supporting our drivers.`);
            }
        }

        function viewReceipt(orderId) {
            alert(`Opening receipt for order ${orderId}...\n\nDetailed breakdown of item cost, delivery fees, tips, and taxes.`);
        }

        function viewReturnReason(orderId) {
            alert(`Return reason for ${orderId}:\n\n"Item was damaged during shipping. Box was wet and contents were affected."\n\nReturn processed on Jan 7, 2025\nReturn fee: $4.50 (charged to seller)`);
        }

        function reorderItem(itemId) {
            alert(`Adding ${itemId.replace('-', ' ')} to your cart...\n\nWould you like to order from the same seller or browse other options?`);
        }

        // Honor System Functions
        let currentHonestyRating = 0;
        
        function openSizeModal() {
            document.getElementById('sizeModal').style.display = 'block';
            updatePricing();
        }
        
        function closeSizeModal() {
            document.getElementById('sizeModal').style.display = 'none';
        }
        
        function updatePricing() {
            const size = document.getElementById('itemSize').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            let fee = 0;
            let feeText = 'No extra fee';
            
            if (size === 'medium' || size === 'large' || size === 'bulk') {
                fee = 25;
                feeText = '+$25.00';
            }
            
            const yourShare = fee / 2;
            
            document.getElementById('deliveryFee').textContent = feeText;
            document.getElementById('yourShare').textContent = '$' + yourShare.toFixed(2);
        }
        
        async function confirmDeliverySize() {
            const size = document.getElementById('itemSize').value;
            const quantity = document.getElementById('itemQuantity').value;
            const orderId = 'MP1234'; // In real app, get from context
            
            try {
                const response = await fetch('/api/delivery/size', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId, size, quantity })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const feeText = data.deliveryFee === 0 ? 'No extra fee' : `+$${data.deliveryFee} oversized fee`;
                    alert(`Delivery size confirmed!\n\nItems: ${quantity}\nSize: ${size}\nOversized Fee: ${feeText}\nYour Share: $${data.yourShare.toFixed(2)}\n\nYour delivery has been updated. The driver will be notified of any changes.`);
                } else {
                    alert('Error updating delivery size: ' + data.message);
                }
            } catch (error) {
                alert('Network error updating delivery size. Please try again.');
                console.error('Error:', error);
            }
            
            closeSizeModal();
        }
        
        function rateHonesty(userId, orderId) {
            document.getElementById('honestyModal').style.display = 'block';
        }
        
        function closeHonestyModal() {
            document.getElementById('honestyModal').style.display = 'none';
            currentHonestyRating = 0;
            document.querySelectorAll('#honestyStars .star').forEach(star => star.classList.remove('active'));
            document.getElementById('honestyComment').value = '';
        }
        
        function setHonestyRating(rating) {
            currentHonestyRating = rating;
            document.querySelectorAll('#honestyStars .star').forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }
        
        async function submitHonestyRating() {
            if (currentHonestyRating === 0) {
                alert('Please select a honesty rating before submitting.');
                return;
            }
            
            const comment = document.getElementById('honestyComment').value;
            const raterId = 'current-user'; // In real app, get from auth context
            const ratedUserId = 'other-user'; // In real app, get from delivery context  
            const orderId = 'MP9999'; // In real app, get from context
            
            try {
                const response = await fetch('/api/delivery/honesty-rating', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        raterId, 
                        ratedUserId, 
                        orderId, 
                        honestyScore: currentHonestyRating, 
                        comment 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const ratingText = currentHonestyRating >= 4 ? 'Accurate size reporting' : 'Size was not accurately reported';
                    alert(`Honesty rating submitted!\n\n‚öñÔ∏è Rating: ${currentHonestyRating} stars\nüìù ${ratingText}\n${comment ? 'üí¨ Comment: ' + comment : ''}\n\nThank you for helping maintain community trust!`);
                } else {
                    alert('Error submitting honesty rating: ' + data.message);
                }
            } catch (error) {
                alert('Network error submitting rating. Please try again.');
                console.error('Error:', error);
            }
            
            closeHonestyModal();
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const ratingModal = document.getElementById('ratingModal');
            const sizeModal = document.getElementById('sizeModal');
            const honestyModal = document.getElementById('honestyModal');
            
            if (e.target === ratingModal) {
                closeRatingModal();
            } else if (e.target === sizeModal) {
                closeSizeModal();
            } else if (e.target === honestyModal) {
                closeHonestyModal();
            }
        });

        // Initialize particles when page loads
        createParticles();
        
        // Create header and main content if not present
        if (!document.querySelector('.header')) {
            const headerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div class="logo-btn" onclick="window.location.href='/'" title="Home">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="stroke: #00bfff;">
                                <rect x="2" y="2" width="20" height="20" rx="3" stroke="currentColor" stroke-width="2" fill="rgba(0, 191, 255, 0.2)"/>
                                <path d="M7 7h10v10H7z" stroke="currentColor" stroke-width="1.5" fill="rgba(0, 191, 255, 0.1)"/>
                                <circle cx="12" cy="12" r="2" fill="currentColor"/>
                            </svg>
                        </div>
                        <div class="header-center">
                            <div class="profile-btn" onclick="window.location.href='/profile'" title="Profile">
                                <img src="" alt="Profile" class="profile-image" style="display: none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display: flex;">DU</span>
                            </div>
                        </div>
                        <div class="header-right">
                            <div class="map-btn" onclick="window.location.href='/interactive-map'" title="Interactive Map">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="stroke: #00bfff;">
                                    <rect x="2" y="2" width="20" height="20" rx="3" stroke="currentColor" stroke-width="2" fill="rgba(0, 191, 255, 0.2)"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/>
                                    <circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="1" opacity="0.6"/>
                                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="0.5" opacity="0.3"/>
                                    <path d="M9 9l6 6M15 9l-6 6" stroke="currentColor" stroke-width="1" opacity="0.4"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', headerHTML);
        }
    </script>
</body>
</html>